# Poster Export Pipeline Stabilization

## Requirements
- 插件导出命令 `export_frame` 在导出前后尝试 `figma.flushAsync()` 并返回 `{ success, base64, ... }` 的直 JSON 结构，禁止再封装 `{content:[{text:...}]}`。
- MCP 服务器 `export_frame` 工具需直接透传插件 JSON，使脚本能够直接读取 `base64` 字段。
- 静态服务器保留 `/upload` 能力作为后续扩展，但当前导出仍以本地 base64 写盘为主。
- 周报脚本需对每张海报串行执行：显式传入 `posterId` 完成 header 填充、meta 更新、自适应高度以及导出，并在导出前后调用 `flush_layout` 加少量 `sleep`。
- `manifest.json` 及相关配置继续限定开发域名为 `localhost`。
- 既有“槽位驱动 + 严格串行填充 + prepare_card_root” 架构保持不变。

## Objectives
- Eliminate poster cross-talk — 所有写操作都绑定当前 `posterId`，避免只更新第一张海报。
- Stabilize export cadence — 导出前后统一 `flush_layout` + `sleep`，防止首帧导出后阻塞 UI。
- Preserve image fill pipeline — 不触碰已稳定的图片填充路径。

## Assumptions & Constraints
- 静态服务器监听 `http://localhost:3056` 并可提供资产/上传能力。
- Node 18 / Bun 环境可访问 Figma MCP WebSocket，网络配置不可修改。
- 三张海报共享相同模板锚点，可复用同一内容 flow。

## Options & Trade-offs
- 继续使用 base64 落盘（实现简单、兼容性好），后续再视需要切换到 HTTP 上传。
- 在导出间引入小延迟保证稳定，但整体流程稍有放缓。
- 透传 JSON 虽减少封装灵活性，但脚本端解析更直接，减少错误面。

## Solution
- 插件 `code.js` 的 `set_poster_title_and_date` 仅在传入 `posterId` 子树内查找节点；`export_frame` 在导出前后 `flushAsync` 并返回直 JSON。
- MCP 服务器 `server.ts` 的 `export_frame` 工具直接返回插件结果（无 `{content:[{text:...}]}` 包裹），其余工具仍显式传递 `posterId`。
- `scripts/run_weekly_poster.js` 在 `fillHeader`、`updatePosterMetaFromDoc`、`resizePosterHeightToContent`、`exportPosterFrame` 中显式传入 `posterId`；导出流程在调用 `export_frame` 前后 `flush_layout` + `sleep`，将 base64 写入 `out/<Poster>_<date>.png`。
- `src/static-server.js` 继续提供 `/upload` 端点作为备选方案，但当前流程未直接调用。

## Acceptance Criteria
- 三张海报的标题/日期、高度、导出文件全部同步更新。
- 每次调用 `export_frame` 返回直 JSON，脚本无需再层层解析。
- `out/` 目录出现三张对应 PNG；脚本与插件日志均无导出阻塞报错。

## Tests
- `bun run build`
- `node scripts/run_weekly_poster.js --channel <test> --content ./docx2json/250915_up_only_content.json --posters "Odaily特供海报,EXIO特供海报,干货铺特供海报" --exportDir out --exportScale 2`
- 手动验证三张海报在 Figma 中标题/日期/高度正确且 `out/` 目录生成对应文件。

## Risks & Mitigations
- 导出仍走 base64，若文件过大可能触发 WebSocket 限制：后续可平滑切换到 `/upload` 方案。
- 每张导出增加的 `sleep` 使流程稍慢：可视稳定性再调低延迟。
- 仍需确保 `posterId` 解析准确；若模板变动需更新锚点名称。

## Rollout & Rollback
- Rollout：同步代码 → 本地跑三张海报脚本 → 截取日志/输出文件 → 提交并通知团队。
- Rollback：若导出仍异常，可回退到旧提交并重新启用 `{content:[{text:...}]}` 包裹及 base64 解析逻辑。
