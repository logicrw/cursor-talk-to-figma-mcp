# Poster Export Pipeline Stabilization

## Requirements
- 插件导出命令需改为 `export_frame_to_server`，在导出前后执行 `figma.flushAsync()`，导出结果通过 `fetch` 以二进制上传到本地静态服务器 `/upload`，返回精简 JSON，禁止再走 MCP WebSocket Base64。
- MCP 服务器需要新增 `export_frame_to_server` 工具，透传请求与响应；保留旧 `export_frame` 以兼容，但响应体必须直接返回插件 JSON，移除 `{content:[{text:...}]}` 包裹，方便脚本端统一解析。
- 静态服务器要实现 `POST /upload`，将请求体写入仓库根目录 `out/` 下的安全文件名，返回 `{ ok: true, path, size }`，失败时返回错误 JSON；需处理 CORS/OPTIONS。
- 周报脚本需将三张海报的处理流程严格串行化：每张独立执行“定位帧 → 清空 Cards → 填 Header → 串行填卡片 → 自适应高度 → flush → 通过新导出工具上传 → 再次 flush + sleep → 下一张”；导出的文件名为 `<海报名>_<doc.date>.png`，失败不得阻断后续海报。
- `manifest.json` 以及所有相关配置必须仅引用 `localhost` 域名，杜绝 `127.0.0.1` 等变体，避免 CSP 与权限问题。
- 现有“槽位驱动 + 严格串行填充 + prepare_card_root”结构保持不变，不做额外重构。

## Objectives
- Eliminate WebSocket base64 overload — 通过 HTTP 上传移除 Base64 大包，避免插件线程阻塞。
- Stabilize multi-poster cadence — 逐帧串行与 flush 节拍保证三张海报独立完成。
- Preserve image fill pipeline — 保持既有槽位/缩放实现不被影响。

## Assumptions & Constraints
- Local static server stays reachable at `http://localhost:3056` — 静态资源与上传都走同一主机端口。
- Automation scripts continue running via Node 18 — 需保持 CommonJS/ESM 兼容写法与旧语法约束。
- Posters share identical layout anchors — 三张海报可复用同一 flow。

## Options & Trade-offs
- Maintain legacy `export_frame` alongside new API — 保留旧命令可兼容未迁移脚本，但需要额外维护。
- Stream upload via existing static server — 复用端口实现简单，但上传流量与静态资产共享资源。
- Introduce per-poster delays — 增加等待提升稳定性，但整体流程略微变慢。

## Solution
- 插件 `code.js` 添加 `export_frame_to_server` 命令分支并实现导出：导出前后尝试 flush；调用 `exportAsync` 后将 `Uint8Array` 的 buffer 直接作为 `fetch` 请求体上传；将响应 JSON 透传回服务器。
- MCP 服务器 `server.ts` 注册新工具，参数包括 `nodeId`、`serverUrl`、`format`、`scale`，调用新的插件命令并直接返回 JSON；同时将旧 `export_frame` 调整为直接返回插件原样 JSON。
- 静态服务器 `static-server.js` 在原 GET 逻辑之外新增 POST `/upload`：清理文件名、mkdir `out/`、流式写入文件并返回路径与字节大小；统一处理 CORS/OPTIONS。
- `run_weekly_poster.js` 引入 `export_frame_to_server` 调用：生成安全文件名与上传 URL，导出前后执行 `flush_layout` 与 `sleep`，导出后按惯例记录日志；每张海报处理完毕后再次 flush+sleep，确保上一张释放资源。原 Base64 写盘逻辑被删去。
- 复核 `manifest.json`，保证白名单仅包含 `ws://localhost:3055` 与 `http://localhost:3056`。

## Acceptance Criteria
- All poster exports upload via `/upload` without WebSocket base64 payloads。
- Running weekly poster script completes three posters sequentially without plugin freeze。
- `out/` directory receives `<poster>_<date>.png` files for each poster run。
- MCP tooling responses provide raw plugin JSON objects for export commands。

## Tests
- `bun run build` — 确认插件与服务器 TypeScript 打包通过。
- `node src/static-server.js` — 启动静态服务器，人工验证 `/upload` 能写入样例文件。
- `node scripts/run_weekly_poster.js --channel <test> --content ./docx2json/250915_up_only_content.json --posters "Odaily特供海报,EXIO特供海报,干货铺特供海报" --exportDir out --exportScale 2` — 串行生成三张海报，检查日志与 `out/` 文件。
- 手动在 Figma 插件内执行导出命令，确认 UI 无卡顿，上传返回路径。

## Risks & Mitigations
- Upload endpoint file overwrite risk — 通过文件名清洗与日期后缀降低冲突。
- Large export sizes impacting disk — 监控 `size` 字段并在脚本中记录便于追踪。
- HTTP upload failures due to network hiccups — 在脚本中保留失败日志并不中断后续帧。

## Rollout & Rollback
- Rollout: 本地完成实现 → 运行三张海报脚本验证 → 截取日志与 `out/` 结果 → 提交代码与设计文档 → 通知团队更新导出流程。
- Rollback: 若观察到导出异常，可临时切回旧 `export_frame` Base64 流程（保留命令），并关闭上传端点改动，随后排查上传失败原因。
