# 项目问题清单

本文档聚焦当前仓库范围内的主要问题与风险（P0–P3），并给出对应的 Remediation 任务与可量化的验收标准（Acceptance Criteria）。对 DOCX 子链路与 docx2json 子模块的稳定性问题，见文末 Appendix。

---

## 资产传输策略（URL-first，Base64-fallback）
- 默认通过 URL（本地静态服务器/CDN）传输图片等二进制资产。
- 仅在以下场景允许 Base64：离线必须、跨域受限无法拉取、或小图标（≤10KB）。
- Base64 需施加阈值与限流：
  - 单次大小阈值：≤10KB（硬阈值，超过则拒绝）。
  - 频率阈值：每通道每分钟 ≤30 次；并发 ≤2，排队执行。
  - 日志层严格脱敏（见“日志与安全”）。
- 建议策略开关：环境变量可控（例如 `ASSET_TRANSFER_MODE=URL_FIRST|BASE64_ONLY`，默认 `URL_FIRST`），便于特殊排障场景临时切换。

---

## 问题清单（按优先级）

### [P0] 大量 Base64 资源经 WebSocket/插件传输，存在内存与阻塞风险
现状与影响
- 插件 `setImageFill` 同时支持 Base64 与 URL；`exportNodeAsImage` 返回大体积 Base64；`workflow_automation.js` 仍准备以 Base64 传图（TODO 未替换为 URL）；WebSocket 未限制消息大小与速率。
- 大体积 Base64 在 Node/插件侧解码、复制与日志序列化过程中放大内存占用，易触发卡顿/超时/崩溃。

Remediation 任务
- 将端到端资产传输改为 “URL-first”：调用方优先传 `imageUrl`，仅在允许条件下回退 Base64。
- 在 MCP 服务器层验证并拒绝超限 Base64（>10KB），对合法 Base64 增加速率与并发控制（队列+背压）。
- 在插件与服务器的消息管道中引入 message-size 上限（例如 1MB 硬上限，默认 256KB 警戒），超限直接拒绝并提示改用 URL。
- 在自动化脚本与内容生成器中把 `set_image_fill` 的默认路径改为 URL（统一指向静态服/CDN）。

Acceptance Criteria
- URL-based image fills cover ≥95% cases; Base64 usage ≤5% and all ≤10KB.
- Requests with Base64 > 10KB are rejected with actionable error.
- Throughput test: 100 images via URL complete without timeouts; memory remains below agreed threshold.
- Message-size guardrails enforced (reject > limit) and logged without sensitive data.

---

### [P0] 日志敏感信息泄漏与日志风暴风险（缺少统一脱敏与 LOG_LEVEL）
现状与影响
- 服务器 `sendCommandToFigma` 使用 debug 打印完整请求，可能包含 `imageBase64`/`data:` URL 等大字段；插件与静态服也有大量 `console.log`。
- 缺少统一 `LOG_LEVEL` 与运行时配置；生产环境可能误开 debug/trace，导致敏感信息外泄与性能退化。

Remediation 任务
- 引入统一日志脱敏模式（默认开启）：对 token、cookie、Authorization、email、dataURL、imageBase64 等字段做红action/mask（头尾保留 4–8 字符，中间以 `***` 替代；长度统计保留）。
- 引入运行时 `LOG_LEVEL`（`error|warn|info|debug|trace`），默认生产 `info`，排障窗口临时上调；各模块只使用统一 logger，不直接 `console.log`。
- 对可能含大量数据的字段采用“长度提示 + 截断样本”策略；禁用在 debug/trace 之外打印大 payload。

Acceptance Criteria
- LOG_LEVEL configurable at runtime; default `info` in production.
- Sensitive fields are masked across server, plugin, and tools.
- No full Base64/dataURL appears in logs at `info` or below.
- Load test shows log volume and CPU within target bounds under `info`.

---

### [P0] WebSocket 通道无鉴权/开放监听，存在未授权访问与注入风险
现状与影响
- `socket.ts` 默认允许 `*` CORS；未见鉴权/令牌；默认监听主机未强制 `127.0.0.1`；任意客户端可加入频道并广播消息。

Remediation 任务
- 将默认监听主机限制为 `127.0.0.1`；对外暴露需显式配置。
- 引入最小鉴权（建议 Bearer token 或 per-channel token），并对加入频道与发送消息都要校验。
- 设置消息大小上限与频率限制（配合上文 Base64 限制）。
- 对错误与拒绝场景给出明确信息（不泄露内部细节）。

Acceptance Criteria
- Server binds to `127.0.0.1` by default; remote exposure requires explicit config.
- Auth enforced for join/send; unauthorized attempts rejected and audited.
- Max message size and rate-limits are enforced and tested.
- Security scan shows no unauthenticated paths for message injection.

---

### [P1] 缺少发送队列与背压：断线/拥塞即刻拒绝，影响稳定性
现状与影响
- `sendCommandToFigma` 在未连接时直接 `reject`，无重试/排队；当插件繁忙/重连时，命令易丢失，影响端到端自动化稳定性。

Remediation 任务
- 在 MCP 侧增加请求队列与重试策略（指数退避），限制并发（如 2–4），结合超时与可取消。
- 在进度事件驱动下动态扩展超时窗口（已存在 progress hooks，可复用）。
- 为关键命令提供 “幂等/可恢复” 语义（例如根据 `commandId` 去重）。

Acceptance Criteria
- Disconnected state no longer drops commands; queued then delivered or cancelled with clear error.
- Concurrency and retry policies verified via integration tests.
- Under transient plugin restarts, end-to-end run completes without manual intervention.

---

### [P1] 静态资源路径硬编码，扩展性与可配置性差
现状与影响
- `static-server.js` 将 `ASSETS_PATH` 指向固定数据集目录；`content-generator.js` 也将 URL 硬编码到该目录，不利于多数据集与环境切换。

Remediation 任务
- 将资源根目录、数据集子路径、端口改为环境变量/配置（例如 `ASSETS_ROOT`, `ASSETS_NAMESPACE`, `STATIC_PORT`）。
- 统一 URL 生成器：由内容的 `asset_id` 与当前命名空间组合生成 URL。
- 增加 404/格式错误的观测日志（脱敏）。

Acceptance Criteria
- Assets root/namespace/port configurable without code changes.
- Switching dataset only requires config change; URLs generated consistently.
- 404 and format errors are observable without leaking sensitive paths.

---

### [P1] `setImageFill` 自动下钻可选错目标子节点，导致视觉错位
现状与影响
- 当前逻辑在 GROUP/INSTANCE 中自动寻找“可填充”的第一个子节点，复杂组件内易选错，造成填充错层。

Remediation 任务
- 支持目标子节点的精确选择：按 name/index/path 选择或显式传递目标 `nodeId`。
- 提供 dry-run 模式输出目标解析结果而非直接改写。

Acceptance Criteria
- Users can target a specific child by name/index/path; dry-run shows resolution.
- No mis-fill observed on representative complex components in tests.

---

### [P2] `export_node_as_image` 仅返回 Base64，难以与 URL-first 策略对齐
现状与影响
- 仅 Base64 输出导致后续链路继续走大负载文本通道。

Remediation 任务
- 增加可选“持久化+URL 返回”模式：将导出结果落地至 `{cache_dir}/<hash>.<ext>` 并返回 URL；Base64 作为 fallback。
- 增加 TTL 与清理策略，避免缓存膨胀。

Acceptance Criteria
- Callers can choose URL output; Base64 path reserved for small payloads.
- Cache directory managed with TTL; disk usage bounded and monitored.

---

### [P2] 日志噪声大、缺少统一结构化与采样
现状与影响
- 多处散落 `console.log`；缺少统一结构化日志与采样，影响排障效率与性能。

Remediation 任务
- 统一 logger（同上 LOG_LEVEL/脱敏），引入结构化日志（JSON 行），对高频事件启用采样。
- 将“大 payload”改为长度+哈希摘要，必要时提供 `--debug-payload` 临时开关。

Acceptance Criteria
- Logs are structured, redact-sensitive fields, and respect LOG_LEVEL.
- High-frequency events are sampled; payloads are summarized not dumped.

---

### [P3] 工程一致性与可维护性待提升
现状与影响
- 仍残留 TODO（如 `workflow_automation.js` 的 MCP 调用）；配置路径与常量分散。

Remediation 任务
- 清理 TODO，集中配置（端口、路径、命名空间、策略阈值）。
- 增补关键路径的集成用例（URL-first 资产填充、断线重试、静态服 404）。

Acceptance Criteria
- No orphan TODOs in core flows; config centralized.
- Key scenarios have passing integration checks.

---

## 日志与安全（统一策略）
- 日志脱敏（默认开启）：对 token、cookie、Authorization、email、dataURL、imageBase64 等敏感/大字段做掩码；打印长度与前后 4–8 个字符用于排障。
- 运行时 `LOG_LEVEL`：`error|warn|info|debug|trace`；生产默认 `info`，排障临时上调并限时。
- 记录但不回显内部细节（如堆栈/路径）至用户可见通道；详细信息进入受控日志后端。
- 开放接口（WebSocket/静态服）默认最小暴露：本机回环、显式白名单与鉴权后再放开。

Acceptance Criteria
- Redaction mode is ON by default; no raw secrets or full data URLs at `info`.
- LOG_LEVEL can be changed without rebuild; debug/trace expire automatically.
- Public endpoints are not accessible remotely unless explicitly enabled.

---

## 后续实施建议（Backlog 拆分）
- PR#1（策略与配置）：引入 URL-first + Base64 限制与开关；集中配置与阈值。
- PR#2（日志与安全）：统一 logger、脱敏与 LOG_LEVEL；WebSocket 本地化与鉴权。
- PR#3（稳定性）：请求队列/背压/重试；消息大小限制与进度驱动超时。
- PR#4（导出与缓存）：`export_node_as_image` 支持 URL 输出与缓存管理。
- PR#5（内容生成器）：全面替换为 URL 资产路径，补足集成测试。

---

最后更新：由仓库问题审阅与“项目总结报告.md”提炼，聚焦当前仓库改进优先级与落地路径。

